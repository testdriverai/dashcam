name: Release

on:
  push:
    branches: [ main, master ]
    tags-ignore:
      - '**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip ci] or [skip release]
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip release]') }}
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
      version: ${{ steps.bump.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and create tag
        id: bump
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          DEFAULT_BUMP: patch
          INITIAL_VERSION: 1.0.0
          RELEASE_BRANCHES: main,master

  build:
    needs: bump-version
    uses: ./.github/workflows/build.yml
    with:
      upload_artifacts: true

  release:
    needs: [bump-version, build]
    runs-on: ubuntu-latest
    if: needs.bump-version.outputs.new_tag != ''
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -R

      - name: Prepare release files
        run: |
          mkdir -p release
          # macOS binaries
          if [ -f dashcam-macos/bundle-arm64 ]; then
            cp dashcam-macos/bundle-arm64 release/dashcam-macos-arm64
            chmod +x release/dashcam-macos-arm64
          fi
          if [ -f dashcam-macos/bundle-x64 ]; then
            cp dashcam-macos/bundle-x64 release/dashcam-macos-x64
            chmod +x release/dashcam-macos-x64
          fi
          # Linux binaries
          if [ -f dashcam-linux/bundle-arm64 ]; then
            cp dashcam-linux/bundle-arm64 release/dashcam-linux-arm64
            chmod +x release/dashcam-linux-arm64
          fi
          if [ -f dashcam-linux/bundle-x64 ]; then
            cp dashcam-linux/bundle-x64 release/dashcam-linux-x64
            chmod +x release/dashcam-linux-x64
          fi
          # Windows binaries
          if [ -f dashcam-windows/bundle-x64.exe ]; then
            cp dashcam-windows/bundle-x64.exe release/dashcam-windows-x64.exe
          fi
          if [ -f dashcam-windows/bundle-arm64.exe ]; then
            cp dashcam-windows/bundle-arm64.exe release/dashcam-windows-arm64.exe
          fi
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.bump-version.outputs.new_tag }}
          name: Release ${{ needs.bump-version.outputs.new_tag }}
          body: |
            ## Dashcam CLI Release ${{ needs.bump-version.outputs.new_tag }}
            
            Automated release with binaries for macOS (x64, ARM64), Linux (x64, ARM64), and Windows (x64, ARM64).
            
            ### Download Instructions
            - **macOS Intel**: `dashcam-macos-x64`
            - **macOS Apple Silicon**: `dashcam-macos-arm64`
            - **Linux x64**: `dashcam-linux-x64`
            - **Linux ARM64**: `dashcam-linux-arm64`
            - **Windows x64**: `dashcam-windows-x64.exe`
            - **Windows ARM64**: `dashcam-windows-arm64.exe`
          files: release/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
